#!/usr/bin/env bash

if [[ ! $1 = "--skip-errors" ]]; then
    set -e
fi

# Update packages
sudo apt update

# Upgrade packages
sudo apt upgrade -y

# Install basic packages
sudo apt install -y curl gcc git gh openssh-client tmux vim zsh

# Install Neovim's build packages
sudo apt install -y build-essential cmake gettext ninja-build unzip

# Install Python's build packages (required, optional)
sudo apt install -y libssl-dev zlib1g-dev
sudo apt install -y libbz2-dev libffi-dev libgdbm-dev liblzma-dev libncursesw5-dev libreadline-dev libsqlite3-dev tk-dev uuid-dev

# Install WSL utilities, if in WSL
[[ -f /etc/wsl.conf ]] && sudo apt install -y wslu

# Remove unnecessary packages
sudo apt autoremove --purge -y

# Clean the apt cache
sudo apt clean -y

# Download .zshenv to export some environment variables
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/main/linux/.zshenv --output-dir $HOME
source ~/.zshenv

# Install Oh My Zsh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh) --unattended"
ZSH_CUSTOM=$ZDOTDIR/ohmyzsh/custom

# Install Powerlevel10k
git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k

# Install plugins to Oh My Zsh
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
git clone https://github.com/MichaelAquilina/zsh-you-should-use.git $ZSH_CUSTOM/plugins/you-should-use

# Download .zshrc and .p10k.zsh
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/main/linux/.config/zsh/.zshrc --output-dir $ZDOTDIR
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/main/linux/.config/zsh/.p10k.zsh --output-dir $ZDOTDIR

# Set up Tmux and its plugins
mkdir -p $XDG_CONFIG_HOME/tmux
curl https://raw.githubusercontent.com/bernardoeuler/configs/refs/heads/main/linux/.config/tmux/tmux.conf -o $XDG_CONFIG_HOME/tmux/tmux.conf
git clone https://github.com/tmux-plugins/tpm $XDG_DATA_HOME/tmux/plugins/tpm
$XDG_DATA_HOME/tmux/plugins/tpm/bin/install_plugins

# Set up vim
mkdir ~/.vim
mkdir ~/.vim/undodir
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/refs/heads/main/linux/.vim/vimrc --output-dir ~/.vim

# Set up git
mkdir $XDG_CONFIG_HOME/git
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/refs/heads/main/linux/.config/git/config --output-dir $XDG_CONFIG_HOME/git
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/refs/heads/main/linux/.config/git/ignore --output-dir $XDG_CONFIG_HOME/git


# Install Neovim
git clone https://github.com/neovim/neovim ~/neovim
cd ~/neovim
git checkout stable
make CMAKE_BUILD_TYPE=RelWithDebInfo CMAKE_EXTRA_FLAGS="-DCMAKE_INSTALL_PREFIX=$HOME/.local/share/neovim"
make install
cd $HOME
[[ -d $HOME/.local/bin ]] || mkdir $HOME/.local/bin
ln -s $HOME/.local/share/neovim/bin/nvim $HOME/.local/bin/nvim

# Install LunarVim
LV_BRANCH="release-1.4/neovim-0.9" bash <(curl -s https://raw.githubusercontent.com/LunarVim/LunarVim/release-1.4/neovim-0.9/utils/installer/install.sh) -y
# Import personal settings
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/refs/heads/main/linux/.config/lvim/config.lua --output-dir $XDG_CONFIG_HOME/lvim

# Install ASDF
ASDF_TEMP_DIR=$HOME/Downloads/.asdf-temp
sudo curl -s https://api.github.com/repos/asdf-vm/asdf/releases/latest | grep "browser_download_url.*linux-amd64.tar.gz" | cut -d : -f 2,3 | tr -d \" | wget -q -P $ASDF_TEMP_DIR -i -;
ASDF_ARCHIVE="$(find $ASDF_TEMP_DIR -iname "asdf*" | grep tar.gz$)"
if echo $(cat $ASDF_ARCHIVE.md5) $ASDF_ARCHIVE | md5sum --check --status; then
    tar -xzf $ASDF_ARCHIVE -C $ASDF_TEMP_DIR
fi
mv $ASDF_TEMP_DIR/asdf $HOME/.local/bin

# Install ASDF plugins
asdf plugin add python
asdf plugin add nodejs
asdf plugin add java
asdf plugin add direnv
asdf plugin add rust

# Install desired Python versions
asdf install python latest
asdf install python latest:3.12
asdf install python latest:2

# Install desired Node.js versions
asdf install nodejs latest
asdf install nodejs latest:22

# Install desired Java versions
asdf install java openjdk-17.0.2

# Install desired Direnv versions
asdf install direnv 2.36.0

# Install desired Rust versions
asdf install rust stable

# Set asdf tools versions
asdf set -u python latest:3.12 
asdf set -u nodejs latest:22 
asdf set -u java openjdk-17.0.2
asdf set -u direnv 2.36.0
asdf set -u rust stable

# Set up ssh config and known hosts
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/main/linux/.ssh/config --output-dir ~/.ssh
curl -O https://raw.githubusercontent.com/bernardoeuler/configs/main/linux/.ssh/known_hosts --output-dir ~/.ssh

# Generate new SSH key for GitHub
echo "Generating SSH key for GitHub"
[[ -d ~/.ssh ]] || mkdir ~/.ssh
chmod 700 ~/.ssh
ssh-keygen -t rsa -f ~/.ssh/github_rsa

# Change default shell to Zsh
echo "Change default shell to zsh"
chsh -s /usr/bin/zsh

# Launch Zsh and start new terminal session
zsh
